import React, {useState, useEffect} from 'react';

const SSENotificationTestPage = () => {
    const [notifications, setNotifications] = useState([]);
    const [sseConnection, setSseConnection] = useState(null);
    const [connectionStatus, setConnectionStatus] = useState('disconnected');
    const [token, setToken] = useState('');
    const [userId, setUserId] = useState('');
    const [apiUrl, setApiUrl] = useState('http://localhost');
    const [logs, setLogs] = useState([]);
    const [unreadCount, setUnreadCount] = useState(0);

    // Î°úÍ∑∏ Ï∂îÍ∞Ä Ìï®Ïàò
    const addLog = (message, type = 'info') => {
        const timestamp = new Date().toLocaleTimeString();
        setLogs(prev => [{
            id: Date.now(),
            message,
            type,
            timestamp
        }, ...prev.slice(0, 19)]);
    };

    // ÏùΩÏßÄ ÏïäÏùÄ ÏïåÎ¶º Í∞úÏàò Í≥ÑÏÇ∞
    useEffect(() => {
        const count = notifications.filter(notif => notif.isRead !== 'Y').length;
        setUnreadCount(count);
    }, [notifications]);

    // SSE Ïó∞Í≤∞
    const connectSSE = () => {
        // if (!token) {
        //     addLog('ÌÜ†ÌÅ∞Ïù¥ ÏóÜÏäµÎãàÎã§. Î®ºÏ†Ä ÌÜ†ÌÅ∞ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.', 'error');
        //     return;
        // }

        if (sseConnection) {
            sseConnection.close();
        }

        addLog('SSE Ïó∞Í≤∞ ÏãúÎèÑ Ï§ë...', 'info');
        setConnectionStatus('connecting');

        // EventSourceÎäî Ìó§ÎçîÎ•º ÏÑ§Ï†ïÌï† Ïàò ÏóÜÏúºÎØÄÎ°ú ÏøºÎ¶¨ ÌååÎùºÎØ∏ÌÑ∞Î°ú ÌÜ†ÌÅ∞ Ï†ÑÎã¨
        // ÎòêÎäî Ïø†ÌÇ§Î•º ÏÇ¨Ïö©ÌïòÍ±∞ÎÇò Î∞±ÏóîÎìúÏóêÏÑú Îã§Î•∏ Î∞©ÏãùÏúºÎ°ú Ïù∏Ï¶ù Íµ¨ÌòÑ
        const url = `${apiUrl}/api/notifications/customer/connect`;

        // ÎòêÎäî ÌÜ†ÌÅ∞ ÏóÜÏù¥ Î®ºÏ†Ä Ïó∞Í≤∞ ÌÖåÏä§Ìä∏
        // const url = `${apiUrl}/api/notifications/connect`;

        try {
            const eventSource = new EventSource(url, {
                withCredentials: true // Ïø†ÌÇ§Î•º Ìè¨Ìï®ÏãúÌÇ§Î†§Î©¥ trueÎ°ú ÏÑ§Ï†ï
            });

            eventSource.onopen = () => {
                addLog('SSE Ïó∞Í≤∞ ÏÑ±Í≥µ', 'success');
                setConnectionStatus('connected');
            };

            eventSource.onmessage = (event) => {
                addLog(`Í∏∞Î≥∏ Î©îÏãúÏßÄ ÏàòÏã†: ${event.data}`, 'info');
            };

            eventSource.addEventListener('connect', (event) => {
                addLog(`Ïó∞Í≤∞ Ïù¥Î≤§Ìä∏: ${event.data}`, 'success');
            });

            eventSource.addEventListener('notification', (event) => {
                try {
                    const notification = JSON.parse(event.data);
                    addLog('ÏïåÎ¶º ÏàòÏã†', 'success');
                    setNotifications(prev => [notification, ...prev]);
                } catch (error) {
                    addLog(`ÏïåÎ¶º ÌååÏã± Ïò§Î•ò: ${error.message}`, 'error');
                }
            });

            eventSource.onerror = (error) => {
                addLog(`SSE Ïó∞Í≤∞ Ïò§Î•ò: ${error}`, 'error');
                setConnectionStatus('error');

                if (eventSource.readyState === EventSource.CLOSED) {
                    addLog('Ïó∞Í≤∞Ïù¥ Îã´ÌòîÏäµÎãàÎã§', 'error');
                    setConnectionStatus('disconnected');
                }
            };

            setSseConnection(eventSource);
        } catch (error) {
            addLog(`EventSource ÏÉùÏÑ± Ïã§Ìå®: ${error.message}`, 'error');
            setConnectionStatus('disconnected');
        }
    };

    // SSE Ïó∞Í≤∞ Ìï¥Ï†ú
    const disconnectSSE = () => {
        if (sseConnection) {
            sseConnection.close();
            setSseConnection(null);
            setConnectionStatus('disconnected');
            addLog('SSE Ïó∞Í≤∞ Ìï¥Ï†ú', 'info');
        }
    };

    // ÏïåÎ¶º ÏùΩÏùå Ï≤òÎ¶¨
    const markAsRead = async (notificationId) => {
        try {
            const response = await fetch(`${apiUrl}/api/notifications/${notificationId}/read`, {
                method: 'PUT',
                credentials: 'include',  // Ïø†ÌÇ§ Ìè¨Ìï®
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            if (response.ok) {
                addLog(`ÏïåÎ¶º ${notificationId} ÏùΩÏùå Ï≤òÎ¶¨ ÏÑ±Í≥µ`, 'success');
                setNotifications(prev =>
                    prev.map(notif =>
                        notif.id === notificationId
                            ? {...notif, isRead: 'Y'}
                            : notif
                    )
                );
            } else {
                throw new Error(`HTTP ${response.status}`);
            }
        } catch (error) {
            addLog(`ÏùΩÏùå Ï≤òÎ¶¨ Ïã§Ìå®: ${error.message}`, 'error');
        }
    };

    // Î™®Îì† ÏïåÎ¶º ÏùΩÏùå Ï≤òÎ¶¨
    const markAllAsRead = async () => {
        if (notifications.length === 0 || unreadCount === 0) return;

        try {
            // Î∞±ÏóîÎìúÏóê Î™®Îì† ÏïåÎ¶º ÏùΩÏùå Ï≤òÎ¶¨ ÏöîÏ≤≠ (Ïã§Ï†ú Íµ¨ÌòÑ ÌïÑÏöî)
            // const response = await fetch(`${apiUrl}/api/notifications/read-all`, {
            //     method: 'PUT',
            //     credentials: 'include',
            //     headers: {
            //         'Content-Type': 'application/json'
            //     }
            // });

            // if (response.ok) {
            // ÌîÑÎ°†Ìä∏ÏóîÎìúÏóêÏÑúÎßå Î™®Îì† ÏïåÎ¶ºÏùÑ ÏùΩÏùå Ï≤òÎ¶¨ (Î∞±ÏóîÎìú Ïó∞ÎèôÏùÄ Ï£ºÏÑù Ìï¥Ï†ú ÌõÑ ÏÇ¨Ïö©)
            setNotifications(prev =>
                prev.map(notif => ({...notif, isRead: 'Y'}))
            );
            addLog('Î™®Îì† ÏïåÎ¶º ÏùΩÏùå Ï≤òÎ¶¨ ÏÑ±Í≥µ', 'success');
            // } else {
            //     throw new Error(`HTTP ${response.status}`);
            // }
        } catch (error) {
            addLog(`Î™®Îì† ÏïåÎ¶º ÏùΩÏùå Ï≤òÎ¶¨ Ïã§Ìå®: ${error.message}`, 'error');
        }
    };

    // Ïª¥Ìè¨ÎÑåÌä∏ Ïñ∏ÎßàÏö¥Ìä∏ Ïãú Ïó∞Í≤∞ Ï†ïÎ¶¨
    useEffect(() => {
        return () => {
            if (sseConnection) {
                sseConnection.close();
            }
        };
    }, [sseConnection]);

    const getStatusColor = () => {
        switch (connectionStatus) {
            case 'connected':
                return '#10b981';
            case 'connecting':
                return '#f59e0b';
            case 'error':
                return '#ef4444';
            default:
                return '#6b7280';
        }
    };

    const getLogTypeColor = (type) => {
        switch (type) {
            case 'success':
                return '#059669';
            case 'error':
                return '#dc2626';
            case 'info':
                return '#2563eb';
            default:
                return '#4b5563';
        }
    };

    return (
        <div style={{minHeight: '100vh', backgroundColor: '#f9fafb', padding: '1rem'}}>
            <div style={{maxWidth: '1200px', margin: '0 auto'}}>
                <div style={{display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '2rem'}}>
                    <h1 style={{fontSize: '1.875rem', fontWeight: 'bold', color: '#1f2937', display: 'flex', alignItems: 'center'}}>
                        SSE ÏïåÎ¶º ÌÖåÏä§Ìä∏
                        {/* ÏÉàÎ°ú Ï∂îÍ∞Ä: ÏÉÅÎã® ÏïåÎ¶º Î±ÉÏßÄ */}
                        {notifications.length > 0 && (
                            <div style={{
                                display: 'flex',
                                alignItems: 'center',
                                marginLeft: '0.75rem',
                                backgroundColor: '#eff6ff',
                                borderRadius: '0.5rem',
                                padding: '0.25rem 0.75rem',
                                border: '1px solid #bfdbfe'
                            }}>
                                <span style={{marginRight: '0.5rem'}}>üîî</span>
                                <span style={{fontWeight: 'bold', color: '#1e40af'}}>Ï†ÑÏ≤¥: {notifications.length}Í∞ú</span>
                                {unreadCount > 0 && (
                                    <span style={{marginLeft: '0.5rem', fontWeight: 'bold', color: '#ef4444'}}>
                                        (ÏùΩÏßÄ ÏïäÏùå: {unreadCount}Í∞ú)
                                    </span>
                                )}
                            </div>
                        )}
                    </h1>
                </div>

                {/* Ïó∞Í≤∞ ÏÑ§Ï†ï */}
                <div style={{
                    backgroundColor: 'white',
                    borderRadius: '0.5rem',
                    boxShadow: '0 1px 3px rgba(0,0,0,0.1)',
                    padding: '1.5rem',
                    marginBottom: '1.5rem'
                }}>
                    <h2 style={{fontSize: '1.25rem', fontWeight: '600', marginBottom: '1rem'}}>Ïó∞Í≤∞ ÏÑ§Ï†ï</h2>

                    <div style={{display: 'flex', flexDirection: 'column', gap: '1rem'}}>
                        <div>
                            <label style={{
                                display: 'block',
                                fontSize: '0.875rem',
                                fontWeight: '500',
                                color: '#374151',
                                marginBottom: '0.25rem'
                            }}>
                                API URL
                            </label>
                            <input
                                type="text"
                                value={apiUrl}
                                onChange={(e) => setApiUrl(e.target.value)}
                                style={{
                                    width: '100%',
                                    padding: '0.5rem 0.75rem',
                                    border: '1px solid #d1d5db',
                                    borderRadius: '0.375rem'
                                }}
                                placeholder="http://localhost"
                            />
                        </div>

                        <div>
                            <label style={{
                                display: 'block',
                                fontSize: '0.875rem',
                                fontWeight: '500',
                                color: '#374151',
                                marginBottom: '0.25rem'
                            }}>
                                JWT ÌÜ†ÌÅ∞
                            </label>
                            <textarea
                                value={token}
                                onChange={(e) => setToken(e.target.value)}
                                style={{
                                    width: '100%',
                                    padding: '0.5rem 0.75rem',
                                    border: '1px solid #d1d5db',
                                    borderRadius: '0.375rem',
                                    resize: 'vertical'
                                }}
                                rows="3"
                                placeholder="Bearer ÌÜ†ÌÅ∞ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî (Bearer Ï†úÏô∏)"
                            />
                        </div>

                        <div>
                            <label style={{
                                display: 'block',
                                fontSize: '0.875rem',
                                fontWeight: '500',
                                color: '#374151',
                                marginBottom: '0.25rem'
                            }}>
                                ÏÇ¨Ïö©Ïûê ID (Ï∞∏Í≥†Ïö©)
                            </label>
                            <input
                                type="text"
                                value={userId}
                                onChange={(e) => setUserId(e.target.value)}
                                style={{
                                    width: '100%',
                                    padding: '0.5rem 0.75rem',
                                    border: '1px solid #d1d5db',
                                    borderRadius: '0.375rem'
                                }}
                                placeholder="ÏÇ¨Ïö©Ïûê ID"
                            />
                        </div>

                        <div style={{display: 'flex', alignItems: 'center', justifyContent: 'space-between'}}>
                            <div style={{display: 'flex', alignItems: 'center', gap: '0.5rem'}}>
                                <div style={{
                                    width: '0.75rem',
                                    height: '0.75rem',
                                    borderRadius: '50%',
                                    backgroundColor: getStatusColor()
                                }}/>
                                <span style={{color: getStatusColor()}}>
                                    {connectionStatus === 'connected' ? 'üü¢ Ïó∞Í≤∞Îê®' : connectionStatus === 'connecting' ? 'üü° Ïó∞Í≤∞ Ï§ë...' : '‚ö™ Ïó∞Í≤∞ Ïïà Îê®'}
                                </span>
                            </div>

                            <div style={{display: 'flex', gap: '0.5rem'}}>
                                <button
                                    onClick={connectSSE}
                                    disabled={connectionStatus === 'connected'}
                                    style={{
                                        padding: '0.5rem 1rem',
                                        backgroundColor: connectionStatus === 'connected' ? '#9ca3af' : '#3b82f6',
                                        color: 'white',
                                        borderRadius: '0.375rem',
                                        border: 'none',
                                        cursor: connectionStatus === 'connected' ? 'not-allowed' : 'pointer'
                                    }}
                                >
                                    Ïó∞Í≤∞
                                </button>
                                <button
                                    onClick={disconnectSSE}
                                    disabled={connectionStatus !== 'connected'}
                                    style={{
                                        padding: '0.5rem 1rem',
                                        backgroundColor: connectionStatus !== 'connected' ? '#9ca3af' : '#ef4444',
                                        color: 'white',
                                        borderRadius: '0.375rem',
                                        border: 'none',
                                        cursor: connectionStatus !== 'connected' ? 'not-allowed' : 'pointer'
                                    }}
                                >
                                    Ïó∞Í≤∞ Ìï¥Ï†ú
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1.5rem'}}>
                    {/* ÏïåÎ¶º Î™©Î°ù */}
                    <div style={{
                        backgroundColor: 'white',
                        borderRadius: '0.5rem',
                        boxShadow: '0 1px 3px rgba(0,0,0,0.1)',
                        padding: '1.5rem'
                    }}>
                        <div style={{
                            display: 'flex',
                            justifyContent: 'space-between',
                            alignItems: 'center',
                            marginBottom: '1rem'
                        }}>
                            <div style={{display: 'flex', alignItems: 'center'}}>
                                <h2 style={{fontSize: '1.25rem', fontWeight: '600', display: 'flex', alignItems: 'center'}}>
                                    üîî ÏïåÎ¶º Î™©Î°ù
                                </h2>
                                {/* ÏÉàÎ°ú Ï∂îÍ∞Ä: ÏïåÎ¶º Ïπ¥Ïö¥ÌÑ∞ */}
                                <div style={{
                                    marginLeft: '0.75rem',
                                    display: 'flex',
                                    alignItems: 'center'
                                }}>
                                    <div style={{
                                        backgroundColor: '#dbeafe',
                                        color: '#1e40af',
                                        fontWeight: 'bold',
                                        padding: '0.25rem 0.75rem',
                                        borderRadius: '2rem',
                                        fontSize: '0.875rem',
                                        border: '1px solid #bfdbfe'
                                    }}>
                                        {notifications.length}
                                    </div>
                                    {unreadCount > 0 && (
                                        <div style={{
                                            backgroundColor: '#fee2e2',
                                            color: '#b91c1c',
                                            fontWeight: 'bold',
                                            padding: '0.25rem 0.75rem',
                                            borderRadius: '2rem',
                                            fontSize: '0.875rem',
                                            marginLeft: '0.5rem',
                                            border: '1px solid #fecaca'
                                        }}>
                                            {unreadCount} Í∞ú ÏùΩÏßÄ ÏïäÏùå
                                        </div>
                                    )}
                                </div>
                            </div>

                            {/* ÏÉàÎ°ú Ï∂îÍ∞Ä: Î™®Îëê ÏùΩÏùå Î≤ÑÌäº */}
                            {unreadCount > 0 && (
                                <button
                                    onClick={markAllAsRead}
                                    style={{
                                        fontSize: '0.875rem',
                                        padding: '0.375rem 0.75rem',
                                        backgroundColor: '#eff6ff',
                                        color: '#3b82f6',
                                        border: '1px solid #bfdbfe',
                                        borderRadius: '0.375rem',
                                        cursor: 'pointer'
                                    }}
                                >
                                    Î™®Îëê ÏùΩÏùå Ï≤òÎ¶¨
                                </button>
                            )}
                        </div>

                        <div style={{maxHeight: '24rem', overflowY: 'auto'}}>
                            {notifications.length === 0 ? (
                                <p style={{color: '#6b7280', textAlign: 'center', padding: '2rem 0'}}>ÏïåÎ¶ºÏù¥ ÏóÜÏäµÎãàÎã§</p>
                            ) : (
                                notifications.map((notification, index) => (
                                    <div
                                        key={notification.id || index}
                                        style={{
                                            padding: '1rem',
                                            border: '1px solid',
                                            borderColor: notification.isRead === 'Y' ? '#e5e7eb' : '#bfdbfe',
                                            borderRadius: '0.5rem',
                                            backgroundColor: notification.isRead === 'Y' ? '#f9fafb' : '#eff6ff',
                                            marginBottom: '0.75rem'
                                        }}
                                    >
                                        <div style={{display: 'flex', justifyContent: 'space-between'}}>
                                            <div style={{flex: 1}}>
                                                <p style={{
                                                    fontSize: '0.875rem',
                                                    color: notification.isRead === 'Y' ? '#4b5563' : '#1f2937',
                                                    fontWeight: notification.isRead === 'Y' ? 'normal' : '500'
                                                }}>
                                                    {notification.content}
                                                </p>
                                                <div style={{
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    marginTop: '0.5rem',
                                                    fontSize: '0.75rem',
                                                    color: '#6b7280'
                                                }}>
                                                    üë§ ÌåêÎß§Ïûê ID: {notification.senderId}
                                                    <span style={{margin: '0 0.5rem'}}>‚Ä¢</span>
                                                    {new Date(notification.createdAt).toLocaleString()}
                                                </div>
                                            </div>

                                            <button
                                                onClick={() => markAsRead(notification.id)}
                                                disabled={notification.isRead === 'Y'}
                                                style={{
                                                    marginLeft: '1rem',
                                                    padding: '0.5rem',
                                                    borderRadius: '50%',
                                                    border: 'none',
                                                    backgroundColor: 'transparent',
                                                    cursor: notification.isRead === 'Y' ? 'default' : 'pointer',
                                                    color: notification.isRead === 'Y' ? '#9ca3af' : '#2563eb'
                                                }}
                                            >
                                                {notification.isRead === 'Y' ? '‚úì' : '‚óã'}
                                            </button>
                                        </div>
                                    </div>
                                ))
                            )}
                        </div>
                    </div>

                    {/* Î°úÍ∑∏ */}
                    <div style={{
                        backgroundColor: 'white',
                        borderRadius: '0.5rem',
                        boxShadow: '0 1px 3px rgba(0,0,0,0.1)',
                        padding: '1.5rem'
                    }}>
                        <h2 style={{
                            fontSize: '1.25rem',
                            fontWeight: '600',
                            marginBottom: '1rem',
                            display: 'flex',
                            alignItems: 'center'
                        }}>
                            ‚ÑπÔ∏è Ïó∞Í≤∞ Î°úÍ∑∏
                        </h2>

                        <div style={{maxHeight: '24rem', overflowY: 'auto'}}>
                            {logs.length === 0 ? (
                                <p style={{color: '#6b7280', textAlign: 'center', padding: '2rem 0'}}>Î°úÍ∑∏Í∞Ä ÏóÜÏäµÎãàÎã§</p>
                            ) : (
                                logs.map((log) => (
                                    <div key={log.id} style={{fontSize: '0.875rem', marginBottom: '0.5rem'}}>
                                        <span style={{color: '#9ca3af'}}>[{log.timestamp}]</span>
                                        <span style={{marginLeft: '0.5rem', color: getLogTypeColor(log.type)}}>
                                            {log.message}
                                        </span>
                                    </div>
                                ))
                            )}
                        </div>

                        {logs.length > 0 && (
                            <button
                                onClick={() => setLogs([])}
                                style={{
                                    marginTop: '1rem',
                                    fontSize: '0.875rem',
                                    color: '#6b7280',
                                    backgroundColor: 'transparent',
                                    border: 'none',
                                    cursor: 'pointer',
                                    display: 'flex',
                                    alignItems: 'center'
                                }}
                            >
                                üóëÔ∏è Î°úÍ∑∏ ÏßÄÏö∞Í∏∞
                            </button>
                        )}
                    </div>
                </div>

                {/* ÏÇ¨Ïö© Î∞©Î≤ï */}
                <div style={{
                    marginTop: '1.5rem',
                    backgroundColor: 'white',
                    borderRadius: '0.5rem',
                    boxShadow: '0 1px 3px rgba(0,0,0,0.1)',
                    padding: '1.5rem'
                }}>
                    <h2 style={{fontSize: '1.25rem', fontWeight: '600', marginBottom: '1rem'}}>ÏÇ¨Ïö© Î∞©Î≤ï</h2>
                    <ol style={{listStyleType: 'decimal', paddingLeft: '1.5rem', color: '#374151'}}>
                        <li style={{marginBottom: '0.5rem'}}>Î∞±ÏóîÎìú API URLÏùÑ ÏûÖÎ†•Ìï©ÎãàÎã§ (Í∏∞Î≥∏Í∞í: http://localhost:8080)</li>
                        <li style={{marginBottom: '0.5rem'}}>Customer Í∂åÌïúÏùÑ Í∞ÄÏßÑ JWT ÌÜ†ÌÅ∞ÏùÑ ÏûÖÎ†•Ìï©ÎãàÎã§</li>
                        <li style={{marginBottom: '0.5rem'}}>"Ïó∞Í≤∞" Î≤ÑÌäºÏùÑ ÌÅ¥Î¶≠ÌïòÏó¨ SSE Ïó∞Í≤∞ÏùÑ ÏãúÏûëÌï©ÎãàÎã§</li>
                        <li style={{marginBottom: '0.5rem'}}>ÌåêÎß§ÏûêÍ∞Ä ÏÉà ÏÉÅÌíàÏùÑ Îì±Î°ùÌïòÎ©¥ Ïã§ÏãúÍ∞ÑÏúºÎ°ú ÏïåÎ¶ºÏùÑ Î∞õÏùÑ Ïàò ÏûàÏäµÎãàÎã§</li>
                        <li style={{marginBottom: '0.5rem'}}>ÏïåÎ¶ºÏùÑ ÌÅ¥Î¶≠ÌïòÏó¨ ÏùΩÏùå Ï≤òÎ¶¨Ìï† Ïàò ÏûàÏäµÎãàÎã§</li>
                        <li style={{marginBottom: '0.5rem'}}>"Î™®Îëê ÏùΩÏùå Ï≤òÎ¶¨" Î≤ÑÌäºÏùÑ ÌÅ¥Î¶≠ÌïòÏó¨ Î™®Îì† ÏïåÎ¶ºÏùÑ ÌïúÎ≤àÏóê ÏùΩÏùå Ï≤òÎ¶¨Ìï† Ïàò ÏûàÏäµÎãàÎã§</li>
                    </ol>
                </div>
            </div>
        </div>
    );
};

export default SSENotificationTestPage;